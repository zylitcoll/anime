---
// Ambil parameter chapterUrlId dari URL (misal: al-150441-1135)
const { chapterUrlId } = Astro.params;

// Ambil data stream dari API (Default reso: 480p)
const response = await fetch(
  `https://api.sansekai.my.id/api/anime/getvideo?chapterUrlId=${chapterUrlId}`,
);
const json = await response.json();
const videoData = json.data[0];

if (!videoData) {
  return Astro.redirect("/404");
}

// Ambil link stream pertama (biasanya 480p sesuai JSON kamu)
const streamSource = videoData.stream[0]?.link;
---

<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Watching Episode {chapterUrlId}</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>
  <body class="bg-black text-white font-sans">
    <nav class="p-4 bg-gray-900/50 backdrop-blur-md sticky top-0 z-50">
      <div class="max-w-6xl mx-auto flex items-center gap-4">
        <a
          href="javascript:history.back()"
          class="hover:text-blue-400 flex items-center gap-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
              clip-rule="evenodd"></path>
          </svg>
          Kembali ke Detail
        </a>
      </div>
    </nav>

    <main class="max-w-5xl mx-auto mt-6 px-4">
      <div
        class="aspect-video bg-gray-800 rounded-xl overflow-hidden shadow-2xl ring-1 ring-white/10"
      >
        {
          streamSource ? (
            <video
              controls
              autoplay
              class="w-full h-full"
              poster="/loading-placeholder.jpg"
            >
              <source src={streamSource} type="video/mp4" />
              Browser Anda tidak mendukung pemutar video ini.
            </video>
          ) : (
            <div class="flex items-center justify-center h-full text-gray-500">
              Link video tidak ditemukan.
            </div>
          )
        }
      </div>

      <div class="mt-8 bg-gray-900/80 p-6 rounded-2xl border border-white/5">
        <div
          class="flex flex-col md:flex-row md:items-center justify-between gap-4"
        >
          <div>
            <h1 class="text-xl font-bold text-blue-400">
              Sedang Memutar: {chapterUrlId}
            </h1>
            <p class="text-sm text-gray-400 mt-1">
              Gunakan resolusi terbaik untuk pengalaman menonton maksimal.
            </p>
          </div>

          <div class="flex items-center gap-6 bg-black/40 px-4 py-2 rounded-lg">
            <div class="flex items-center gap-2 text-green-400">
              <span class="text-sm font-bold">{videoData.likeCount}</span>
              <small class="text-xs opacity-70">Likes</small>
            </div>
            <div class="w-px h-4 bg-gray-700"></div>
            <div class="flex items-center gap-2 text-red-400">
              <span class="text-sm font-bold">{videoData.dislikeCount}</span>
              <small class="text-xs opacity-70">Dislikes</small>
            </div>
          </div>
        </div>

        <div class="mt-6 flex flex-wrap gap-2">
          <span
            class="text-xs font-semibold text-gray-500 uppercase tracking-widest w-full mb-1"
            >Resolusi Tersedia:</span
          >
          {
            videoData.reso.map((r) => (
              <button
                class={`px-4 py-1.5 rounded-md text-xs font-bold border ${r === "480p" ? "bg-blue-600 border-blue-500" : "bg-gray-800 border-gray-700 hover:bg-gray-700"}`}
              >
                {r}
              </button>
            ))
          }
        </div>
      </div>

      <div
        class="mt-4 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg"
      >
        <p class="text-[11px] text-yellow-500/80 leading-relaxed text-center">
          Catatan: Jika video buffering, coba turunkan resolusi atau cek koneksi
          internet Anda. Hosting gratisan biasanya memiliki limit bandwidth
          tertentu.
        </p>
      </div>
    </main>

    <footer class="py-10 text-center text-gray-600 text-[10px]">
      Source ID: {videoData.episode_id} | Provider ID: {
        videoData.stream[0]?.provide
      }
    </footer>
  </body>
</html>
